name: VPS Free via Cloudflare

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Cáº­p nháº­t vÃ  cÃ i Ä‘áº·t SSH
    - name: Update and install packages
      run: |
        sudo apt update && sudo apt install -y wget curl unzip openssh-server ufw
        sudo service ssh start

    # 2. Táº¡o user Ä‘Äƒng nháº­p SSH
    - name: Create user tuan
      run: |
        sudo useradd -m tuan
        echo "tuan:tuan123" | sudo chpasswd
        sudo usermod -aG sudo tuan
        echo "AllowUsers tuan" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart
        echo "SSH sáºµn sÃ ng vá»›i username: tuan vÃ  password: tuan123"

    # 3. Má»Ÿ port tÆ°á»ng lá»­a
    - name: Configure firewall
      run: |
        sudo ufw allow 22
        sudo ufw allow 443
        sudo ufw --force enable

    # 4. CÃ i Ä‘áº·t Cloudflared
    - name: Install Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    # 5. Khá»Ÿi cháº¡y Cloudflare Tunnel
    - name: Start Cloudflare Tunnel for SSH
      run: |
        echo "ðŸš€ Äang khá»Ÿi cháº¡y Cloudflare Tunnel..."
        nohup cloudflared tunnel --no-autoupdate --url tcp://localhost:22 --protocol auto > tunnel.log 2>&1 &
        sleep 10
        echo "===== Ná»™i dung tunnel.log ====="
        cat tunnel.log
        echo "===== Link SSH Public ====="
        grep -Eo "https://[a-zA-Z0-9.-]+.trycloudflare.com" tunnel.log

    # 6. Giá»¯ VPS hoáº¡t Ä‘á»™ng 6 tiáº¿ng
    - name: Keep VPS Alive
      run: |
        echo "VPS Ä‘ang cháº¡y trong 6 tiáº¿ng..."
        sleep 21600
