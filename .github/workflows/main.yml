name: Free VPS GitHub + Cloudflare

on:
  workflow_dispatch: # Ch·∫°y th·ªß c√¥ng
  push:               # Ch·∫°y khi push code

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # VPS t·ªëi ƒëa 6 ti·∫øng

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Update & Install Packages
      run: |
        sudo apt update && sudo apt upgrade -y
        sudo apt install curl wget git unzip tmux -y
        echo "‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!"

    # C√†i ƒë·∫∑t Cloudflare Tunnel
    - name: Install Cloudflare Tunnel
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        echo "‚úÖ Cloudflare Tunnel ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t!"

    # T·∫°o user "tuan" v√† c√†i SSH server
    - name: Setup SSH with custom user
      run: |
        sudo apt install openssh-server -y
        sudo useradd -m -s /bin/bash tuan
        echo "tuan:tuan123" | sudo chpasswd
        sudo usermod -aG sudo tuan
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        echo "AllowUsers tuan" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart
        echo "‚úÖ SSH ƒë√£ s·∫µn s√†ng! Username: tuan | Password: tuan123"

    # Ch·∫°y Cloudflare Tunnel ƒë·ªÉ m·ªü k·∫øt n·ªëi SSH
    - name: Start Cloudflare Tunnel for SSH
      run: |
        nohup cloudflared tunnel --url ssh://localhost:22 --no-autoupdate > tunnel.log 2>&1 &
        sleep 5
        echo "üîó ƒê·ªãa ch·ªâ SSH c·ªßa b·∫°n:"
        cat tunnel.log | grep -o 'tcp://[0-9a-zA-Z\.\-]*trycloudflare.com:[0-9]*' || echo "Kh√¥ng t√¨m th·∫•y link, ki·ªÉm tra l·∫°i log!"

    # Gi·ªØ VPS online 6 ti·∫øng
    - name: Keep VPS Alive
      run: |
        echo "VPS ƒëang ch·∫°y trong 6 ti·∫øng..."
        tmux new -d -s keepalive 'while true; do sleep 30; done'
        sleep 21600
