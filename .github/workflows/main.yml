name: VPS Free via Cloudflare RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Update and install packages
      run: |
        sudo apt update
        sudo apt install -y wget curl unzip openssh-server xrdp xfce4 xfce4-goodies
        sudo systemctl enable xrdp --now
        echo "âœ… XRDP Ä‘Ã£ Ä‘Æ°á»£c cÃ i vÃ  khá»Ÿi Ä‘á»™ng!"

    - name: Create user tuan
      run: |
        sudo useradd -m tuan
        echo "tuan:tuan123" | sudo chpasswd
        sudo usermod -aG sudo tuan
        echo "AllowUsers tuan" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart
        echo "ğŸ‘¤ User 'tuan' Ä‘Ã£ sáºµn sÃ ng! Username: tuan | Password: tuan123"

    - name: Install Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        echo "ğŸŒ Cloudflared Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t!"

    - name: Start Cloudflare Tunnel for RDP
      run: |
        echo "ğŸš€ Äang khá»Ÿi cháº¡y Cloudflare Tunnel (RDP)..."
        # Khá»Ÿi cháº¡y tunnel trÃªn port 3389 cho RDP
        nohup cloudflared tunnel --url tcp://localhost:3389 --no-autoupdate > tunnel.log 2>&1 &
        sleep 10

        echo "===== Ná»™i dung tunnel.log ====="
        cat tunnel.log

        echo "===== Link Public Ä‘á»ƒ káº¿t ná»‘i RDP ====="
        # Láº¥y link *.trycloudflare.com tá»« log
        LINK=$(grep -Eo "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log | head -n 1)
        echo "ğŸŒ Public RDP Link: $LINK"
        if [ -z "$LINK" ]; then
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y link public trong tunnel.log"
          exit 1
        fi

    - name: Keep VPS Alive
      run: |
        echo "ğŸ’» VPS Ä‘ang cháº¡y trong 6 tiáº¿ng..."
        sleep 21600
