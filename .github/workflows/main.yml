name: Free VPS GitHub + Cloudflare

on:
  workflow_dispatch: # Cháº¡y thá»§ cÃ´ng
  push:               # Cháº¡y khi push code

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # VPS cháº¡y tá»‘i Ä‘a 6 tiáº¿ng

    steps:
    # BÆ°á»›c 1: Checkout repo
    - name: Checkout Repo
      uses: actions/checkout@v3

    # BÆ°á»›c 2: Update & cÃ i gÃ³i cáº§n thiáº¿t
    - name: Update & Install Packages
      run: |
        sudo apt update && sudo apt upgrade -y
        sudo apt install curl wget git unzip tmux -y
        echo "âœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!"

    # BÆ°á»›c 3: CÃ i Ä‘áº·t Cloudflare Tunnel
    - name: Install Cloudflare Tunnel
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        echo "âœ… Cloudflare Tunnel Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t!"

    # BÆ°á»›c 4: CÃ i SSH Server vÃ  táº¡o user tuan
    - name: Setup SSH with custom user
      run: |
        sudo apt install openssh-server -y
        sudo useradd -m -s /bin/bash tuan
        echo "tuan:tuan123" | sudo chpasswd
        sudo usermod -aG sudo tuan
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        echo "AllowUsers tuan" | sudo tee -a /etc/ssh/sshd_config
        sudo service ssh restart
        echo "âœ… SSH Ä‘Ã£ sáºµn sÃ ng! Username: tuan | Password: tuan123"

    # BÆ°á»›c 5: Cháº¡y Cloudflare Tunnel Ä‘á»ƒ má»Ÿ káº¿t ná»‘i SSH
    - name: Start Cloudflare Tunnel for SSH
      run: |
        echo "ğŸ”„ Äang khá»Ÿi cháº¡y Cloudflare Tunnel..."
        nohup cloudflared tunnel --url tcp://localhost:22 --no-autoupdate > tunnel.log 2>&1 &
        sleep 8
        echo "ğŸ”— Äá»‹a chá»‰ SSH cá»§a báº¡n (copy Ä‘áº§y Ä‘á»§ dÃ²ng bÃªn dÆ°á»›i Ä‘á»ƒ káº¿t ná»‘i):"
        cat tunnel.log | grep -o 'tcp://[0-9a-zA-Z\.\-]*trycloudflare.com:[0-9]*' || echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y link, hÃ£y xem ná»™i dung log bÃªn dÆ°á»›i:"
        echo "===== Ná»™i dung tunnel.log ====="
        cat tunnel.log
        echo "=============================="

    # BÆ°á»›c 6: Giá»¯ VPS hoáº¡t Ä‘á»™ng trong 6 tiáº¿ng
    - name: Keep VPS Alive
      run: |
        echo "â³ VPS Ä‘ang cháº¡y trong 6 tiáº¿ng..."
        tmux new -d -s keepalive 'while true; do sleep 30; done'
        sleep 21600
